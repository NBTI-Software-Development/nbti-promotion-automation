[0;34m[INFO][0m Starting deployment for environment: development
[0;34m[INFO][0m Loading environment configuration...
[0;34m[INFO][0m Running pre-deployment checks...
[0;34m[INFO][0m Running tests...
[0;34m[INFO][0m Running backend tests...
/home/ubuntu/.local/lib/python3.10/site-packages/flask_limiter/extension.py:333: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
  warnings.warn(
 * Serving Flask app 'main'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://172.31.26.48:5000
Press CTRL+C to quit
 * Restarting with stat
/home/ubuntu/.local/lib/python3.10/site-packages/flask_limiter/extension.py:333: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
  warnings.warn(
 * Debugger is active!
 * Debugger PIN: 821-684-549
[2025-10-07 07:35:52,606] INFO in security: REQUEST: GET /api/health from 127.0.0.1
127.0.0.1 - - [07/Oct/2025 07:35:52] "GET /api/health HTTP/1.1" 200 -
[2025-10-07 07:35:52,610] INFO in security: REQUEST: POST /api/auth/register from 127.0.0.1
[2025-10-07 07:35:52,614] WARNING in security: ERROR_RESPONSE: 400 for POST /api/auth/register
127.0.0.1 - - [07/Oct/2025 07:35:52] "POST /api/auth/register HTTP/1.1" 400 -
[2025-10-07 07:35:52,617] INFO in security: REQUEST: POST /api/auth/login from 127.0.0.1
127.0.0.1 - - [07/Oct/2025 07:35:52] "POST /api/auth/login HTTP/1.1" 200 -
[2025-10-07 07:35:52,958] INFO in security: REQUEST: GET /api/auth/me from 127.0.0.1
127.0.0.1 - - [07/Oct/2025 07:35:52] "GET /api/auth/me HTTP/1.1" 200 -
[2025-10-07 07:35:52,967] INFO in security: REQUEST: GET /api/pms/dashboard from 127.0.0.1
[2025-10-07 07:35:52,969] WARNING in security: ERROR_RESPONSE: 403 for GET /api/pms/dashboard
127.0.0.1 - - [07/Oct/2025 07:35:52] "GET /api/pms/dashboard HTTP/1.1" 403 -
[2025-10-07 07:35:52,972] INFO in security: REQUEST: GET /api/emm/dashboard from 127.0.0.1
[2025-10-07 07:35:52,976] WARNING in security: ERROR_RESPONSE: 403 for GET /api/emm/dashboard
127.0.0.1 - - [07/Oct/2025 07:35:52] "GET /api/emm/dashboard HTTP/1.1" 403 -
🚀 NBTI Promotion Automation - Test Suite
==================================================
Starting test server...

=== API Endpoint Tests ===
✅ Health endpoint working
❌ User registration failed: 400 - {
  "error": "Username already exists"
}

✅ User login working
✅ Get current user working
❌ PMS dashboard failed: 403
❌ EMM dashboard failed: 403

=== Test Results ===
✅ Passed: 3
❌ Failed: 3
📊 Total: 6

=== Code Quality Tests ===

❌ Test runner error: Table 'pms_evaluations' is already defined for this MetaData instance.  Specify 'extend_existing=True' to redefine options and columns on an existing Table object.

🛑 Stopping test server...
[1;33m[WARNING][0m Some backend tests failed
[0;34m[INFO][0m Running frontend tests...

> nbti-frontend@0.0.0 test:run /home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend
> vitest run


 RUN  v3.2.4 /home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend

stderr | src/contexts/__tests__/AuthContext.test.jsx > AuthContext > handles logout correctly
Logout API call failed: TypeError: __vite_ssr_import_2__.authAPI.logout is not a function
    at logout [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39msrc/contexts/AuthContext.jsx:177:21[90m)[39m
    at executeDispatch [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:16368:9[90m)[39m
    at runWithFiberInDEV [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:1522:13[90m)[39m
    at processDispatchQueue [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:16418:19[90m)[39m
    at [90m/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:17016:9
    at batchedUpdates$1 [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:3262:40[90m)[39m
    at dispatchEventForPluginEventSystem [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:16572:7[90m)[39m
    at dispatchEvent [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:20658:11[90m)[39m
    at dispatchDiscreteEvent [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/react-dom@19.1.0_react@19.1.0/node_modules/[4mreact-dom[24m/cjs/react-dom-client.development.js:20626:11[90m)[39m
    at HTMLDivElement.callTheUserObjectsOperation [90m(/home/ubuntu/nbti-promotion-automation/frontend/nbti-frontend/[39mnode_modules/[4m.pnpm[24m/jsdom@27.0.0_postcss@8.5.3/node_modules/[4mjsdom[24m/lib/jsdom/living/generated/EventListener.js:26:30[90m)[39m

 ❯ src/contexts/__tests__/AuthContext.test.jsx (6 tests | 4 failed) 159ms
   ✓ AuthContext > provides initial unauthenticated state 35ms
   × AuthContext > handles login correctly 21ms
     → [2mexpect([22m[31melement[39m[2m).toHaveTextContent()[22m

Expected element to have text content:
[32m  testuser - Staff Member[39m
Received:
[31m  no-user[39m
   ✓ AuthContext > handles logout correctly 40ms
   × AuthContext > checks roles correctly 36ms
     → [2mexpect([22m[31melement[39m[2m).toHaveTextContent()[22m

Expected element to have text content:
[32m  has-staff-role[39m
Received:
[31m  no-staff-role[39m
   × AuthContext > restores authentication from localStorage 21ms
     → expected "spy" to be called at least once
   × AuthContext > handles token refresh failure 4ms
     → expected "spy" to be called with arguments: [ 'access_token' ][90m

Number of calls: [1m0[22m
[39m
 ✓ src/components/auth/__tests__/LoginForm.test.jsx (5 tests) 1318ms
   ✓ LoginForm > submits form with valid data  302ms

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 4 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  src/contexts/__tests__/AuthContext.test.jsx > AuthContext > handles login correctly
Error: [2mexpect([22m[31melement[39m[2m).toHaveTextContent()[22m

Expected element to have text content:
[32m  testuser - Staff Member[39m
Received:
[31m  no-user[39m
 ❯ src/contexts/__tests__/AuthContext.test.jsx:77:45
     75|     
     76|     expect(screen.getByTestId('auth-status')).toHaveTextContent('authe…
     77|     expect(screen.getByTestId('user-info')).toHaveTextContent('testuse…
       |                                             ^
     78|     expect(screen.getByTestId('has-staff-role')).toHaveTextContent('ha…
     79|     

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/4]⎯

 FAIL  src/contexts/__tests__/AuthContext.test.jsx > AuthContext > checks roles correctly
Error: [2mexpect([22m[31melement[39m[2m).toHaveTextContent()[22m

Expected element to have text content:
[32m  has-staff-role[39m
Received:
[31m  no-staff-role[39m
 ❯ src/contexts/__tests__/AuthContext.test.jsx:123:50
    121|     })
    122|     
    123|     expect(screen.getByTestId('has-staff-role')).toHaveTextContent('ha…
       |                                                  ^
    124|   })
    125| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[2/4]⎯

 FAIL  src/contexts/__tests__/AuthContext.test.jsx > AuthContext > restores authentication from localStorage
AssertionError: expected "spy" to be called at least once
 ❯ src/contexts/__tests__/AuthContext.test.jsx:155:36
    153|     })
    154|     
    155|     expect(authAPI.getCurrentUser).toHaveBeenCalled()
       |                                    ^
    156|   })
    157| 

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[3/4]⎯

 FAIL  src/contexts/__tests__/AuthContext.test.jsx > AuthContext > handles token refresh failure
AssertionError: expected "spy" to be called with arguments: [ 'access_token' ][90m

Number of calls: [1m0[22m
[39m
 ❯ src/contexts/__tests__/AuthContext.test.jsx:180:41
    178|     
    179|     expect(screen.getByTestId('auth-status')).toHaveTextContent('not-a…
    180|     expect(localStorageMock.removeItem).toHaveBeenCalledWith('access_t…
       |                                         ^
    181|   })
    182| })

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[4/4]⎯


 Test Files  1 failed | 1 passed (2)
      Tests  4 failed | 7 passed (11)
   Start at  07:35:56
   Duration  6.46s (transform 384ms, setup 402ms, collect 1.52s, tests 1.48s, environment 2.41s, prepare 277ms)

 ELIFECYCLE  Command failed with exit code 1.
[1;33m[WARNING][0m Some frontend tests failed
[0;34m[INFO][0m Stopping existing containers...
time="2025-10-07T07:36:02Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
[0;34m[INFO][0m Building and starting services...
time="2025-10-07T07:36:02Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
#1 [internal] load local bake definitions
#1 reading from stdin 1.20kB done
#1 DONE 0.0s

#2 [frontend internal] load build definition from Dockerfile
#2 transferring dockerfile: 1.24kB 0.0s done
#2 WARN: FromAsCasing: 'as' and 'FROM' keywords' casing do not match (line 2)
#2 WARN: FromAsCasing: 'as' and 'FROM' keywords' casing do not match (line 23)
#2 DONE 0.0s

#3 [backend internal] load build definition from Dockerfile
#3 transferring dockerfile: 1.95kB 0.1s done
#3 DONE 0.1s

#4 [frontend internal] load metadata for docker.io/library/node:18-alpine
#4 ...

#5 [frontend internal] load metadata for docker.io/library/nginx:alpine
#5 DONE 0.4s

#4 [frontend internal] load metadata for docker.io/library/node:18-alpine
#4 DONE 0.4s

#6 [frontend internal] load .dockerignore
#6 transferring context: 2B done
#6 DONE 0.0s

#7 [backend internal] load metadata for docker.io/library/python:3.11-slim
#7 DONE 1.8s

#8 [frontend builder 1/7] FROM docker.io/library/node:18-alpine@sha256:8d6421d663b4c28fd3ebc498332f249011d118945588d0a35cb9bc4b8ca09d9e
#8 DONE 0.0s

#9 [frontend production 1/6] FROM docker.io/library/nginx:alpine@sha256:42a516af16b852e33b7682d5ef8acbd5d13fe08fecadc7ed98605ba5e3b26ab8
#9 DONE 0.0s

#10 [frontend internal] load build context
#10 ...

#11 [backend internal] load .dockerignore
#11 transferring context: 2B 0.1s done
#11 DONE 0.1s

#12 [backend internal] load build context
#12 DONE 0.0s

#10 [frontend internal] load build context
#10 ...

#13 [backend builder 1/5] FROM docker.io/library/python:3.11-slim@sha256:9bffe4353b925a1656688797ebc68f9c525e79b1d377a764d232182a519eeec4
#13 resolve docker.io/library/python:3.11-slim@sha256:9bffe4353b925a1656688797ebc68f9c525e79b1d377a764d232182a519eeec4 0.1s done
#13 DONE 0.1s

#10 [frontend internal] load build context
#10 ...

#12 [backend internal] load build context
#12 transferring context: 490.51kB 1.3s done
#12 DONE 1.6s

#14 [backend production 6/7] COPY . .
#14 CACHED

#15 [backend production 2/7] RUN apt-get update && apt-get install -y     libpq5     curl     && rm -rf /var/lib/apt/lists/*     && apt-get clean
#15 CACHED

#16 [backend builder 2/5] RUN apt-get update && apt-get install -y     build-essential     libpq-dev     curl     && rm -rf /var/lib/apt/lists/*
#16 CACHED

#17 [backend builder 4/5] COPY requirements.txt .
#17 CACHED

#18 [backend production 4/7] COPY --from=builder /opt/venv /opt/venv
#18 CACHED

#19 [backend production 3/7] RUN groupadd -r appuser && useradd -r -g appuser appuser
#19 CACHED

#20 [backend builder 3/5] RUN python -m venv /opt/venv
#20 CACHED

#21 [backend builder 5/5] RUN pip install --upgrade pip &&     pip install -r requirements.txt
#21 CACHED

#22 [backend production 5/7] WORKDIR /app
#22 CACHED

#23 [backend production 7/7] RUN mkdir -p /var/log/nbti-api /var/uploads/nbti &&     chown -R appuser:appuser /app /var/log/nbti-api /var/uploads/nbti
#23 CACHED

#24 [backend] exporting to image
#24 exporting layers done
#24 writing image sha256:2b9a80fc46876787eceeb0de0b3acad4ff41a1f17f0684ca1a5877d3e5eaa60c done
#24 naming to docker.io/library/nbti-promotion-automation-backend done
#24 DONE 0.0s

#10 [frontend internal] load build context
#10 ...

#25 [backend] resolving provenance for metadata file
#25 DONE 0.1s

#10 [frontend internal] load build context
#10 transferring context: 3.57MB 5.8s done
#10 DONE 7.3s

#26 [frontend builder 2/7] WORKDIR /app
#26 CACHED

#27 [frontend builder 3/7] RUN npm install -g pnpm
#27 CACHED

#28 [frontend builder 4/7] COPY package.json pnpm-lock.yaml ./
#28 CACHED

#29 [frontend builder 5/7] RUN pnpm install --frozen-lockfile
#29 CACHED

#30 [frontend builder 6/7] COPY . .
#30 DONE 39.8s

#31 [frontend builder 7/7] RUN pnpm run build
#31 2.780 
#31 2.780 > nbti-frontend@0.0.0 build /app
#31 2.780 > vite build
#31 2.780 
#31 4.150 vite v6.3.5 building for production...
#31 4.258 transforming...
#31 14.68 ✓ 2200 modules transformed.
#31 16.63 rendering chunks...
#31 21.02 computing gzip size...
#31 25.19 dist/index.html                   0.46 kB │ gzip:   0.29 kB
#31 25.35 dist/assets/index-DpYBlPI1.css   38.99 kB │ gzip:   6.74 kB
#31 25.98 dist/assets/index-kBcaVsny.js   721.62 kB │ gzip: 220.59 kB
#31 27.60 
#31 27.60 (!) Some chunks are larger than 500 kB after minification. Consider:
#31 27.60 - Using dynamic import() to code-split the application
#31 27.60 - Use build.rollupOptions.output.manualChunks to improve chunking: https://rollupjs.org/configuration-options/#output-manualchunks
#31 27.60 - Adjust chunk size limit for this warning via build.chunkSizeWarningLimit.
#31 28.48 ✓ built in 23.49s
#31 DONE 29.4s

#32 [frontend production 4/6] COPY --from=builder /app/dist /usr/share/nginx/html
#32 CACHED

#33 [frontend production 5/6] COPY nginx.conf /etc/nginx/nginx.conf
#33 CACHED

#34 [frontend production 2/6] RUN apk update && apk upgrade && apk add --no-cache curl
#34 CACHED

#35 [frontend production 3/6] RUN addgroup -g 1001 -S nodejs &&     adduser -S nextjs -u 1001
#35 CACHED

#36 [frontend production 6/6] RUN mkdir -p /var/cache/nginx /var/log/nginx /var/run &&     chown -R nextjs:nodejs /var/cache/nginx /var/log/nginx /var/run /usr/share/nginx/html
#36 CACHED

#37 [frontend] exporting to image
#37 exporting layers done
#37 writing image sha256:99411c92fc14ee7659a8187e49278cf6b48cdd7eab4747906d316efbc3fe193c done
#37 naming to docker.io/library/nbti-promotion-automation-frontend 0.0s done
#37 DONE 0.0s

#38 [frontend] resolving provenance for metadata file
#38 DONE 0.1s
 nbti-promotion-automation-backend  Built
 nbti-promotion-automation-frontend  Built
 Network nbti-promotion-automation_nbti-network  Creating
 Network nbti-promotion-automation_nbti-network  Created
 Container nbti-redis  Creating
 Container nbti-database  Creating
 Container nbti-redis  Created
 Container nbti-database  Created
 Container nbti-backend  Creating
 Container nbti-backend  Created
 Container nbti-frontend  Creating
 Container nbti-frontend  Created
 Container nbti-database  Starting
 Container nbti-redis  Starting
 Container nbti-redis  Started
 Container nbti-database  Started
 Container nbti-redis  Waiting
 Container nbti-database  Waiting
 Container nbti-redis  Healthy
 Container nbti-database  Healthy
 Container nbti-backend  Starting
 Container nbti-backend  Started
 Container nbti-backend  Waiting
 Container nbti-backend  Healthy
 Container nbti-frontend  Starting
 Container nbti-frontend  Started
[0;34m[INFO][0m Waiting for services to be healthy...
[0;34m[INFO][0m Checking service health...
time="2025-10-07T07:38:17Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
[0;32m[SUCCESS][0m Database is healthy
time="2025-10-07T07:38:17Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
[0;32m[SUCCESS][0m Backend is healthy
time="2025-10-07T07:38:17Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
[0;32m[SUCCESS][0m Frontend is healthy
[0;34m[INFO][0m Running database migrations...
time="2025-10-07T07:38:17Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
Error: Could not locate a Flask application. Use the 'flask --app' option, 'FLASK_APP' environment variable, or a 'wsgi.py' or 'app.py' file in the current directory.

Usage: flask [OPTIONS] COMMAND [ARGS]...
Try 'flask --help' for help.

Error: No such command 'db'.
[1;33m[WARNING][0m Migration failed or no migrations to run
[0;34m[INFO][0m Initializing default data...
time="2025-10-07T07:38:19Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
/opt/venv/lib/python3.11/site-packages/flask_limiter/extension.py:333: UserWarning: Using the in-memory storage for tracking rate limits as no storage was explicitly specified. This is not recommended for production use. See: https://flask-limiter.readthedocs.io#configuring-a-storage-backend for documentation about configuring the storage backend.
  warnings.warn(
Admin user already exists
[0;32m[SUCCESS][0m Deployment completed successfully!

[0;34m[INFO][0m Deployment Summary:
  Environment: development
  Frontend URL: http://localhost:3000
  Backend URL: http://localhost:5000
  API Documentation: http://localhost:5000/api/docs

[0;34m[INFO][0m Development credentials:
  Username: admin
  Password: admin123

[0;34m[INFO][0m To view logs: docker-compose logs -f [service_name]
[0;34m[INFO][0m To stop services: docker-compose down
[0;34m[INFO][0m Running containers:
time="2025-10-07T07:38:21Z" level=warning msg="/home/ubuntu/nbti-promotion-automation/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion"
NAME            IMAGE                                COMMAND                  SERVICE    CREATED          STATUS                    PORTS
nbti-backend    nbti-promotion-automation-backend    "gunicorn --bind 0.0…"   backend    53 seconds ago   Up 21 seconds (healthy)   0.0.0.0:5000->5000/tcp, [::]:5000->5000/tcp
nbti-database   postgres:15-alpine                   "docker-entrypoint.s…"   database   53 seconds ago   Up 52 seconds (healthy)   0.0.0.0:5432->5432/tcp, [::]:5432->5432/tcp
nbti-frontend   nbti-promotion-automation-frontend   "/docker-entrypoint.…"   frontend   52 seconds ago   Up 15 seconds (healthy)   0.0.0.0:80->80/tcp, [::]:80->80/tcp, 0.0.0.0:443->443/tcp, [::]:443->443/tcp
nbti-redis      redis:7-alpine                       "docker-entrypoint.s…"   redis      53 seconds ago   Up 52 seconds (healthy)   0.0.0.0:6379->6379/tcp, [::]:6379->6379/tcp
